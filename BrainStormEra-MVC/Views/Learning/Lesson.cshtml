@model LessonDetailViewModel
@{
    ViewData["Title"] = Model.LessonName + " - " + Model.CourseName;
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"] - BrainStormEra</title>
    <meta name="description" content="@Model.LessonName - @Model.CourseName - Learning Lesson - BrainStormEra">
    <link rel="icon" type="image/x-icon" href="~/SharedMedia/logo/logowithoutbackground.png" sizes="48x48">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link rel="stylesheet" href="~/css/global.css">
    <link rel="stylesheet" href="~/css/layouts/base.css">
    <link rel="stylesheet" href="~/css/components/header.css">
    <link rel="stylesheet" href="~/css/components/loader.css">
    <link rel="stylesheet" href="~/css/pages/Learning/lesson-viewer.css">
    <link rel="stylesheet" href="~/css/components/footer.css">
    <link rel="stylesheet" href="~/css/pages/HomePage/enhanced-home.css">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" as="style">
    <!-- Load page loader script -->
    <script src="~/js/components/loader.js"></script>
    <!-- Toast notifications CSS -->
    <link rel="stylesheet" href="~/css/components/toast-notifications.css">
    <!-- Chatbot CSS -->
    <link rel="stylesheet" href="~/css/components/chatbot.css">
    

    
    @* User authentication meta tags for JavaScript access *@
    @if (User.Identity?.IsAuthenticated == true)
    {
        <meta name="user-id" content="@User.FindFirst("UserId")?.Value" />
        <meta name="user-role" content="@User.FindFirst("UserRole")?.Value" />
        <meta name="user-name" content="@(User.FindFirst("FullName")?.Value ?? User.Identity.Name)" />
    }
</head>

<body>
    <!-- Page Loader -->
    <div class="page-loader">
        <div class="loader"></div>
    </div>

    <!-- Display toast notifications from TempData -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div data-toast-success="@TempData["SuccessMessage"]" style="display:none;"></div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div data-toast-error="@TempData["ErrorMessage"]" style="display:none;"></div>
    }
    @if (TempData["WarningMessage"] != null)
    {
        <div data-toast-warning="@TempData["WarningMessage"]" style="display:none;"></div>
    }
    @if (TempData["InfoMessage"] != null)
    {
        <div data-toast-info="@TempData["InfoMessage"]" style="display:none;"></div>
    }

    <!-- Header -->
    @await Html.PartialAsync("~/Views/Shared/Header/_Header.cshtml")

    <!-- Learning Container -->
    <div class="container-fluid learning-container">
        <!-- Learning Breadcrumb -->
        <div class="learning-breadcrumb">
            <div class="container">
                <div class="breadcrumb-content">
                    <div class="course-breadcrumb">
                        <a href="@Url.ActionWithHash("Course", "Learning", (string)ViewBag.CourseHashId)">
                            <i class="fas fa-arrow-left"></i> @Model.CourseName
                        </a>
                        <span>/</span>
                        <span>@Model.ChapterName</span>
                        <span>/</span>
                        <strong>@Model.LessonName</strong>
                    </div>
                    
                    <div class="lesson-actions">
                        @if (ViewBag.PreviousLessonHashId != null)
                        {
                            <a href="@Url.ActionWithHash("Lesson", "Learning", (string)ViewBag.PreviousLessonHashId)" 
                               class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        }
                        
                        <button id="markCompleteBtn" class="btn btn-success btn-sm" 
                                @(Model.IsCompleted ? "disabled" : "")
                                onclick="markLessonComplete()">
                            @if (Model.IsCompleted)
                            {
                                <text><i class="fas fa-check"></i> Completed</text>
                            }
                            else
                            {
                                <text><i class="fas fa-check-circle"></i> Mark Complete</text>
                            }
                        </button>
                        
                        @if (ViewBag.NextLessonHashId != null)
                        {
                            <a href="@Url.ActionWithHash("Lesson", "Learning", (string)ViewBag.NextLessonHashId)" 
                               class="btn btn-primary btn-sm">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Learning Content -->
        <div class="container">
            <div class="learning-content">
                <!-- Left Sidebar - Course Navigation -->
                <div class="course-sidebar" id="courseNavigationContainer">
                    <!-- Navigation will be loaded here -->
                    <div class="loading-navigation" style="padding: 20px; text-align: center; color: #6b7280;">
                        <i class="fas fa-spinner fa-spin"></i> Loading course navigation...
                    </div>
                </div>

                <!-- Right Content Area - Lesson Content -->
                <div class="lesson-content-area">
                    <!-- Lesson Header -->
                    <div class="lesson-header-content">
                        <h1 class="lesson-title">@Model.LessonName</h1>
                        <div class="lesson-meta">
                            <span class="lesson-type">
                                @switch (Model.LessonTypeName.ToLower())
                                {
                                    case "video":
                                        <i class="fas fa-video"></i>
                                        break;
                                    case "text":
                                        <i class="fas fa-file-alt"></i>
                                        break;
                                    case "interactive":
                                        <i class="fas fa-mouse-pointer"></i>
                                        break;
                                    default:
                                        <i class="fas fa-circle"></i>
                                        break;
                                }
                                @Model.LessonTypeName
                            </span>
                            <span class="lesson-number">Lesson @Model.LessonOrder</span>
                            @if (Model.TimeSpent.HasValue)
                            {
                                <span class="time-spent">
                                    <i class="fas fa-clock"></i> @Model.TimeSpent.Value.TotalMinutes.ToString("F0")m spent
                                </span>
                            }
                        </div>
                        
                        @if (!string.IsNullOrEmpty(Model.LessonDescription))
                        {
                            <p class="lesson-description" style="margin: 0; color: #6b7280; font-size: 14px;">@Model.LessonDescription</p>
                        }
                        
                        <div class="lesson-progress-header">
                            <span style="font-size: 14px; color: #6b7280;">Progress: <strong id="progressPercentage">@Model.CompletionPercentage.ToString("F0")%</strong></span>
                            <div class="progress-bar-header">
                                <div id="progressFill" class="progress-fill-header" style="width: @Model.CompletionPercentage%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Lesson Content -->
                    <div class="lesson-main-content">
                        <div class="lesson-content" id="lessonContent">
                            @if (Model.LessonTypeId == 1) // Video
                            {
                                <div class="video-container">
                                    @if (Model.LessonContent.Contains("youtube.com") || Model.LessonContent.Contains("youtu.be"))
                                    {
                                        var videoId = "";
                                        if (Model.LessonContent.Contains("youtube.com/watch?v="))
                                        {
                                            videoId = Model.LessonContent.Split("watch?v=")[1].Split("&")[0];
                                        }
                                        else if (Model.LessonContent.Contains("youtu.be/"))
                                        {
                                            videoId = Model.LessonContent.Split("youtu.be/")[1].Split("?")[0];
                                        }
                                        <iframe id="videoPlayer" 
                                                src="https://www.youtube.com/embed/@videoId?enablejsapi=1" 
                                                frameborder="0" 
                                                allowfullscreen
                                                class="video-iframe">
                                        </iframe>
                                    }
                                    else
                                    {
                                        <video id="videoPlayer" controls class="video-player">
                                            <source src="@Model.LessonContent" type="video/mp4">
                                            Your browser does not support the video tag.
                                        </video>
                                    }
                                </div>
                            }
                            else if (Model.LessonTypeId == 2) // Text
                            {
                                <div class="text-content">
                                    @Html.Raw(Model.LessonContent)
                                </div>
                            }
                            else if (Model.LessonTypeId == 3) // Interactive/Document
                            {
                                <div class="interactive-content">
                                    @if (Model.LessonContent.EndsWith(".pdf"))
                                    {
                                        <div class="pdf-viewer">
                                            <embed src="@Model.LessonContent" type="application/pdf" class="pdf-embed">
                                            <p>
                                                <a href="@Model.LessonContent" target="_blank" class="btn btn-outline-primary">
                                                    <i class="fas fa-external-link-alt"></i> Open PDF in new tab
                                                </a>
                                            </p>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="document-content">
                                            @Html.Raw(Model.LessonContent)
                                        </div>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Quiz Section -->
                        @if (Model.HasQuiz)
                        {
                            <div class="quiz-section">
                                <h3 style="margin-bottom: 16px; color: #1f2937;">Quiz for this lesson</h3>
                                @foreach (var quiz in Model.Quizzes)
                                {
                                    <div class="quiz-card">
                                        <div class="quiz-info">
                                            <h4 style="margin-bottom: 8px;">@quiz.QuizTitle</h4>
                                            @if (!string.IsNullOrEmpty(quiz.QuizDescription))
                                            {
                                                <p style="color: #6b7280; margin-bottom: 12px;">@quiz.QuizDescription</p>
                                            }
                                            <div class="quiz-meta" style="display: flex; gap: 16px; font-size: 14px; color: #6b7280; margin-bottom: 16px;">
                                                <span><i class="fas fa-question"></i> @quiz.TotalQuestions questions</span>
                                                <span><i class="fas fa-star"></i> @quiz.PassingScore% passing score</span>
                                                @if (quiz.TimeLimit > 0)
                                                {
                                                    <span><i class="fas fa-clock"></i> @quiz.TimeLimit minutes</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="quiz-actions">
                                            @if (quiz.HasPassed)
                                            {
                                                <span class="quiz-status passed" style="color: #059669; font-weight: 500;">
                                                    <i class="fas fa-check-circle"></i> Passed (@quiz.BestScore%)
                                                </span>
                                            }
                                            else
                                            {
                                                @if (quiz.CanRetake)
                                                {
                                                    <a href="@Url.ActionWithHash("Details", "Quiz", (string)quiz.QuizId)" 
                                                       class="btn btn-primary">
                                                        <i class="fas fa-play"></i> Take Quiz
                                                    </a>
                                                }
                                                else
                                                {
                                                    <span class="quiz-status failed" style="color: #dc2626; font-weight: 500;">
                                                        <i class="fas fa-times-circle"></i> Max attempts reached
                                                    </span>
                                                }
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    @await Html.PartialAsync("~/Views/Shared/Footer/_Footer.cshtml")

    @* Include Chatbot for authenticated users *@
    @await Html.PartialAsync("~/Views/Shared/_Chatbot.cshtml")

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/global.js"></script>
    <script src="~/js/imageErrorHandler.js"></script>
    <script src="~/js/pages/Learning/lesson-viewer.js"></script>
    <script src="~/js/components/toast-notifications.js"></script>

    @* Chatbot Script for authenticated users *@
    @if (User.Identity?.IsAuthenticated == true)
    {
        @Html.AntiForgeryToken()
        <script src="~/js/components/chatbot.js"></script>
    }

    <!-- Initialize lesson viewer -->
    <script>
        // Initialize lesson viewer with data from server
        document.addEventListener('DOMContentLoaded', function() {
            const lessonId = '@ViewBag.LessonHashId';
            const courseId = '@ViewBag.CourseHashId';
            
            if (typeof initializeLessonViewer === 'function') {
                initializeLessonViewer(lessonId, courseId);
            }
        });
    </script>
</body>

</html> 